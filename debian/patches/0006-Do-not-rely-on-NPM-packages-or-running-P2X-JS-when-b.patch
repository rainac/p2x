From: Johannes Willkomm <johannes@johannes-willkomm.de>
Date: Wed, 1 Jun 2022 21:57:07 +0200
Subject: Do not rely on NPM packages or running P2X JS when building

---
 configure.ac         |  9 +++++++--
 src-js/Makefile.am   | 15 +++++++++++----
 tests/sh/Makefile.am |  2 +-
 3 files changed, 19 insertions(+), 7 deletions(-)

diff --git a/configure.ac b/configure.ac
index 0349917..c413a40 100644
--- a/configure.ac
+++ b/configure.ac
@@ -35,10 +35,10 @@ AM_CONDITIONAL(acond_NPM_AVAIL, [test "x$NPM" != "x"])
 
 if [test "x$NPM" != "x"]; then
    npm_packages="most-xml tmp node-minify"
-   npm_packages_avail=1
+   npm_packages_avail=yes
    for pkg in $npm_packages; do
        if ! $NPM list -g $pkg > /dev/null; then
-          npm_packages_avail=0
+          npm_packages_avail=
           AC_MSG_WARN([mandatory program node-js module "$pkg" is not installed
 			please do "$NPM install -g $pkg"])
        fi
@@ -232,10 +232,15 @@ echo " re2c:           [$RE2C]"
 echo " trang:          [$TRANG]"
 echo " gengetopt:      [$GENGETOPT]"
 echo " emacs:          [$EMACS]"
+if test "$build_tests" = "yes"; then
 echo " xmlstarlet:     [$XMLSTARLET]"
 echo " shunit2:        [$SHUNIT2]"
 echo " valgrind:       [$VALGRIND]"
+fi
 echo ""
 echo " npm:            [$NPM]"
+echo " npm packages:   [$npm_packages_avail]"
+if test "$build_tests" = "yes"; then
 echo " mocha:          [$MOCHA]"
+fi
 echo ""
diff --git a/src-js/Makefile.am b/src-js/Makefile.am
index 497ae2f..58fe4f1 100644
--- a/src-js/Makefile.am
+++ b/src-js/Makefile.am
@@ -12,9 +12,14 @@ unmin_files = $(ncd_files) scanner.js hashmap.js parse-xml.js parse-opts.js p2x.
 
 min_files = $(addsuffix .min.js, $(basename $(unmin_files)))
 
-generated_files = $(min_files) $(json_files) node_modules_updated.txt
+generated_files = $(json_files) node_modules_updated.txt
 
-project_files = $(min_files) $(json_files) $(unmin_files)
+project_files = $(json_files) $(unmin_files)
+
+if acond_NPM_PKGS_AVAIL
+	generated_files += $(min_files)
+	project_files += $(min_files)
+endif
 
 inst_DATA = $(project_files)
 
@@ -23,8 +28,8 @@ gennc-common.js: token.ncd.js
 %.ncd.js: $(top_srcdir)/src/xml/%.ncd.xml
 	gennc -m JavaScript $^
 
-%.json: $(top_srcdir)/src/xml/%.xml node_modules_updated.txt scanconf-xml2json.min.js $(min_files)
-	./p2xjs scanconf-xml2json -S $< -o $@
+%.json: $(top_srcdir)/src/xml/%.xml node_modules_updated.txt $(unmin_files)
+	./p2xjs scanconf-xml2json --unmin -S $< -o $@
 
 %.min.js: %.js compress.js node_modules_updated.txt
 	sed -e '/require/ s/.js/.min.js/' $< > $<.tmp
@@ -55,7 +60,9 @@ node_modules:
 
 $(node_modules) node_modules_updated.txt: node_modules Makefile.am
 	touch node_modules_updated.txt
+if acond_NPM_PKGS_AVAIL
 	npm link $(node_module_names)
+endif
 
 $(instdir):
 	$(INSTALL) -d $@
diff --git a/tests/sh/Makefile.am b/tests/sh/Makefile.am
index 630548c..d40b8fa 100644
--- a/tests/sh/Makefile.am
+++ b/tests/sh/Makefile.am
@@ -6,7 +6,7 @@ parse_tests merge_tests p2x_tests test_output_stability indent_tests	\
 valgrind_tests output_mode_json_merged output_mode_json			\
 output_mode_matlab_merged output_mode_matlab cdecls
 
-if acond_NPM_AVAIL
+if acond_NPM_PKGS_AVAIL
 good += p2xjs_mocha_tests test_cmp_js
 endif
 
