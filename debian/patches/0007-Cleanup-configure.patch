From: Johannes Willkomm <johannes@johannes-willkomm.de>
Date: Fri, 3 Jun 2022 22:10:19 +0200
Subject: Cleanup configure

---
 Makefile.am          |  5 ++++-
 configure.ac         | 49 ++++++++++++++++++++++++++++---------------------
 tests/sh/Makefile.am | 12 ++++++++----
 3 files changed, 40 insertions(+), 26 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 36e23b9..ea71b29 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -4,7 +4,10 @@
 # See the file p2x.cc for copying conditions.  
 #
 
-SUBDIRS = src examples tests
+SUBDIRS = examples tests
+if acond_CPLUSPLUS_ENABLED
+SUBDIRS += src
+endif
 if acond_NPM_AVAIL
 SUBDIRS += src-js
 endif
diff --git a/configure.ac b/configure.ac
index 00f1ec0..cc8fda2 100644
--- a/configure.ac
+++ b/configure.ac
@@ -20,28 +20,18 @@ AC_PROG_LN_S
 AC_PROG_RANLIB
 AC_PROG_LEX([yywrap])
 
-AC_CHECK_TOOL([STRIP], [strip], [strip-for-host-system-was-not-found])
-AC_CHECK_PROGS([CP], [cp copy])
-AC_CHECK_PROGS([RM], [rm del])
-AC_CHECK_PROGS([MV], [mv rename])
-AC_CHECK_PROGS([BASENAME], [basename])
-AC_CHECK_PROGS([GHEAD], [ghead head])
-
-AC_CHECK_PROGS([GENGETOPT], [gengetopt])
-AM_CONDITIONAL(acond_GENGETOPT_AVAIL, [test "x$GENGETOPT" != "x"])
-
-AC_CHECK_PROGS([NPM], [npm])
-AM_CONDITIONAL(acond_NPM_AVAIL, [test "x$NPM" != "x"])
-
 AC_ARG_ENABLE([js], [  --enable-js    Enable install of P2X JS implementation.
   --disable-js   No VCS version file.], [
       js_enabled=$enableval
 ], [
-      js_enabled=yes
+      js_enabled=no
 ])
 AM_CONDITIONAL(acond_JS_ENABLED, [test "$js_enabled" = "yes"])
 
 if [test "$js_enabled" = "yes"]; then
+
+AC_CHECK_PROGS([NPM], [npm])
+
 if [test "x$NPM" != "x"]; then
    npm_packages="most-xml tmp node-minify"
    npm_packages_avail=yes
@@ -54,22 +44,30 @@ if [test "x$NPM" != "x"]; then
    done
 fi
 fi
+AM_CONDITIONAL(acond_NPM_AVAIL, [test "x$NPM" != "x"])
 AM_CONDITIONAL(acond_NPM_PKGS_AVAIL, [test "$npm_packages_avail" != ""])
 
 AC_CHECK_PROGS([TRANG], [trang])
 AM_CONDITIONAL(acond_TRANG_AVAIL, [test "x$TRANG" != "x"])
 
+
+AC_ARG_ENABLE([cplusplus], [  --enable-cplusplus    Enable install of P2X CPLUSPLUS implementation.
+  --disable-cplusplus   No VCS version file.], [
+      cplusplus_enabled=$enableval
+], [
+      cplusplus_enabled=no
+])
+AM_CONDITIONAL(acond_CPLUSPLUS_ENABLED, [test "$cplusplus_enabled" = "yes"])
+
+if [test "$cplusplus_enabled" = "yes"]; then
+AC_CHECK_PROGS([GENGETOPT], [gengetopt])
+
 AC_CHECK_PROGS([FLEX], [flex])
-AM_CONDITIONAL(acond_FLEX_AVAIL, [test "x$FLEX" != "x"])
 if test "x$FLEX" = "x"; then
   AC_MSG_ERROR([mandatory program flex was not found])
 fi
 
 AC_CHECK_PROGS([RE2C], [re2c])
-AM_CONDITIONAL(acond_RE2C_AVAIL, [test "x$FLEX" != "x"])
-
-AC_CHECK_PROGS([EMACS], [emacs])
-AM_CONDITIONAL(acond_EMACS_AVAIL, [test "x$EMACS" != "x"])
 
 AC_ARG_ENABLE([static], [  --enable-static         Build statically linked executables.
   --disable-static        Build dynamically linked executables.], [
@@ -86,7 +84,6 @@ else
    defval_STATIC_BUILD=0
 fi
 AC_DEFINE_UNQUOTED([P2X_STATIC_BUILD], [$defval_STATIC_BUILD], [1: static build])
-AM_CONDITIONAL(acond_STATIC_BUILD, [test "x$static_build" = "xyes"])
 
 AC_ARG_ENABLE([debug], [  --enable-debug         Build debugally linked executables.
   --disable-debug        Build dynamically linked executables.], [
@@ -104,7 +101,17 @@ else
    defval_DEBUG_BUILD=0
 fi
 AC_DEFINE_UNQUOTED([P2X_DEBUG_BUILD], [$defval_DEBUG_BUILD], [1: debug build])
-AM_CONDITIONAL(acond_DEBUG_BUILD, [test "x$debug_build" = "xyes"])
+
+fi
+
+AM_CONDITIONAL(acond_GENGETOPT_AVAIL, [test "$GENGETOPT" != ""])
+AM_CONDITIONAL(acond_FLEX_AVAIL, [test "$FLEX" != ""])
+AM_CONDITIONAL(acond_RE2C_AVAIL, [test "$FLEX" != ""])
+AM_CONDITIONAL(acond_STATIC_BUILD, [test "$static_build" = "yes"])
+AM_CONDITIONAL(acond_DEBUG_BUILD, [test "$debug_build" = "yes"])
+
+AC_CHECK_PROGS([EMACS], [emacs])
+AM_CONDITIONAL(acond_EMACS_AVAIL, [test "x$EMACS" != "x"])
 
 AC_ARG_ENABLE([tests], [  --enable-tests         Build test code.], [
       build_tests=$enableval
diff --git a/tests/sh/Makefile.am b/tests/sh/Makefile.am
index d40b8fa..cb3613b 100644
--- a/tests/sh/Makefile.am
+++ b/tests/sh/Makefile.am
@@ -1,10 +1,14 @@
 
 generated_files = all_tests.sh test_cmp_js.sh test_cmp_jsy.sh test_reparse.sh test_reproduce_strict.sh test_reproduce.sh test_output_stability.sh forall_tests.sh
 
-good = val_tests test_reproduce_strict test_reproduce test_reparse	\
-parse_tests merge_tests p2x_tests test_output_stability indent_tests	\
-valgrind_tests output_mode_json_merged output_mode_json			\
-output_mode_matlab_merged output_mode_matlab cdecls
+good =
+
+if acond_CPLUSPLUS_ENABLED
+good += val_tests test_reproduce_strict test_reproduce test_reparse	\
+ parse_tests merge_tests p2x_tests test_output_stability indent_tests	\
+ valgrind_tests output_mode_json_merged output_mode_json		\
+ output_mode_matlab_merged output_mode_matlab cdecls
+endif
 
 if acond_NPM_PKGS_AVAIL
 good += p2xjs_mocha_tests test_cmp_js
