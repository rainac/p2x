From: Johannes Willkomm <johannes@johannes-willkomm.de>
Date: Mon, 23 May 2022 17:07:56 +0200
Subject: val_tests

---
 tests/sh/val_tests.sh | 44 +++++++-------------------------------------
 1 file changed, 7 insertions(+), 37 deletions(-)

diff --git a/tests/sh/val_tests.sh b/tests/sh/val_tests.sh
index 3cc01ab..f4e932c 100755
--- a/tests/sh/val_tests.sh
+++ b/tests/sh/val_tests.sh
@@ -1,44 +1,14 @@
 #! /bin/bash
 
-. setup_sh.sh
-
-runWithTimeout() {
-    rm -f done.txt fail.txt
-    ($* && touch done.txt || touch fail.txt) &
-    bpid=$!
-#    echo "job started: $bpid"
-    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do
-        if [[ -e done.txt ]] || [[ -e fail.txt ]]; then
-            break
-        fi
-        if ! [[ "$i" = 15 ]]; then
-            sleep 0.1
-        fi
-    done
-    if [[ -e done.txt ]]; then
-        rm -f fail.txt
-        rm done.txt
-        true
-    else
-        if [[ -e fail.txt ]]; then
-            rm fail.txt
-            false
-        else
-            echo "The job $bpid did not terminate!"
-            kill $bpid
-            kill $bpid
-            kill $bpid
-            killall $1
-            killall $1
-            killall $1
-            # its not my fault it didn't terminate
-            true
-        fi
-    fi
-}
+. setup.sh
 
 mydir=$(dirname $BASH_SOURCE)
 
+grammar=$P2X_HOME/share/p2x/code-xml.rng
+if ! [[ -f $grammar ]]; then
+    grammar=$mydir/../../src/code-xml.rng
+fi
+
 testOutputValid() {
 
     for i in $mydir/../../examples/in/*.exp; do
@@ -52,7 +22,7 @@ testOutputValid() {
         fi
         $P2X $P2XFLAGS $opts -p $mydir/../../examples/configs/default $i > $tmpdir/res.xml
 #        runWithTimeout xmlstarlet val -e -r ../../src/code-xml.rng res.xml
-        xmlstarlet val -b -e -r $mydir/../../src/code-xml.rng $tmpdir/res.xml
+        xmlstarlet val -b -e -r $grammar $tmpdir/res.xml
         assertEquals "Validating XML output for $i failed" 0 $?
 #        rm $tmpdir/res.xml
     done
